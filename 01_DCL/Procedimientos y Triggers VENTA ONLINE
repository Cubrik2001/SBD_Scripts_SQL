PASO A PASO DE QUE HAY QUE IMPLEMENTAR Y ARRREGLAR PARA QUE FUNCIONE BIEN EL MODULO DE VENTAS ONLINE 

-- 1. TIPOS DE COLECCIÓN (Para enviar el carrito de compras al PL/SQL)
CREATE OR REPLACE TYPE t_detalle_compra_obj AS OBJECT (
    id_juguete   NUMBER, -- ID del producto (JUGUETES_LEGO.id)
    cantidad     NUMBER
);
/

CREATE OR REPLACE TYPE t_productos_compra AS TABLE OF t_detalle_compra_obj;
/

-- 2. AJUSTE DE COLUMNAS EXISTENTES (Si no se hizo correctamente antes)
--    Aumentar la precisión de TOTAL (solución a ORA-01438)
ALTER TABLE FACTURAS_ONLINE
MODIFY total NUMBER(10, 2);

-- 3. VALIDACIÓN DE CLAVE FORÁNEA EN DETALLE (Necesario para descontar stock)
--    Asegura que DET_FACTURAS_ONLINE.id_juguete_cat apunte a JUGUETES_LEGO.id.
--    (Asume que la tabla DET_FACTURAS_ONLINE ya existe.)
ALTER TABLE DET_FACTURAS_ONLINE 
    ADD CONSTRAINT FK_DET_ONLINE_JUGUETE 
    FOREIGN KEY (id_juguete_cat) REFERENCES JUGUETES_LEGO(id);

Propósito: Le enseña a Oracle a entender la estructura de un "Carrito de Compras" completo.

1. t_detalle_compra_obj (El Objeto)
Función: Define la estructura de una sola línea del carrito. Es decir, le dice a Oracle que una línea de compra es una combinación de un id_juguete y su cantidad.

Analogía: Es como definir una "fila" de una hoja de Excel.

2. t_productos_compra (La Colección)
Función: Define una "Tabla" (o lista) compuesta por muchos objetos t_detalle_compra_obj.

Analogía: Es la hoja de Excel completa, que contiene múltiples filas.

PARTE 2 

-- FUNCIÓN 1: CALCULAR EDAD (Necesario para la regla +21)
CREATE OR REPLACE FUNCTION edad(p_fecha DATE) RETURN NUMBER IS
BEGIN
    RETURN TRUNC(MONTHS_BETWEEN(SYSDATE, p_fecha) / 12);
END;
/

-- FUNCIÓN 2: VERIFICAR UNIÓN EUROPEA (Para el cálculo de envío)
CREATE OR REPLACE FUNCTION fn_es_pais_ue (p_id_pais IN NUMBER) RETURN CHAR IS
    v_es_ue CHAR(1);
BEGIN
    SELECT ue INTO v_es_ue
    FROM PAISES
    WHERE id = p_id_pais;
    RETURN v_es_ue;
EXCEPTION
    WHEN NO_DATA_FOUND THEN RETURN 'N';
END fn_es_pais_ue;
/

-- FUNCIÓN 3: PUNTOS GANADOS (Define la recompensa por la compra actual)
CREATE OR REPLACE FUNCTION fn_calcular_puntos_ganados (p_total IN NUMBER) RETURN NUMBER IS
BEGIN
    IF p_total >= 500 THEN RETURN 50;
    ELSIF p_total >= 300 THEN RETURN 30;
    ELSIF p_total >= 100 THEN RETURN 10;
    ELSE RETURN 5;
    END IF;
END;
/

-- FUNCIÓN 4: CÁLCULO DE SALDO DISPONIBLE (Event Sourcing - Core Logic)
--            Calcula los puntos que el cliente puede canjear, leyendo el historial.
CREATE OR REPLACE FUNCTION fn_calcular_puntos_disponibles (
    p_id_cliente IN NUMBER
) RETURN NUMBER IS
    v_ultimo_reinicio NUMBER;
    v_total_puntos    NUMBER;
BEGIN
    -- Busca el ID de la última factura donde el cliente canjeó puntos
    SELECT NVL(MAX(numero_venta), 0)
    INTO v_ultimo_reinicio
    FROM FACTURAS_ONLINE
    WHERE id_lego_cliente = p_id_cliente
      AND gratis = 'S';

    -- Suma los puntos ganados SOLAMENTE desde esa última factura de canje
    SELECT NVL(SUM(puntos_generados), 0)
    INTO v_total_puntos
    FROM FACTURAS_ONLINE
    WHERE id_lego_cliente = p_id_cliente
      AND numero_venta > v_ultimo_reinicio;

    RETURN v_total_puntos;
END;
/



PARTE 3

-- TRIGGER 1: CALCULAR ENVÍO (Suma 5% o 15% al TOTAL antes de guardarse)
CREATE OR REPLACE TRIGGER trg_bi_fact_online_envio
BEFORE INSERT ON FACTURAS_ONLINE
FOR EACH ROW
DECLARE
    v_id_pais_cliente NUMBER;
    v_monto_envio     NUMBER(10, 2);
BEGIN
    -- Si es canje (Total 0), no sumamos envío.
    IF :NEW.total = 0 THEN
        RETURN; 
    END IF;

    -- Obtener el país de residencia del cliente
    SELECT id_pais_res INTO v_id_pais_cliente
    FROM CLIENTES WHERE id_lego = :NEW.id_lego_cliente;

    -- Calcular Recargo
    IF fn_es_pais_ue(v_id_pais_cliente) = 'S' THEN
        v_monto_envio := :NEW.total * 0.05; -- 5% (Unión Europea)
    ELSE
        v_monto_envio := :NEW.total * 0.15; -- 15% (Resto del Mundo)
    END IF;

    -- Actualizar el campo TOTAL
    :NEW.total := :NEW.total + v_monto_envio;
    
EXCEPTION
    WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20001, 'Error al calcular envío: ' || SQLERRM);
END;
/

-- TRIGGER 2: DESCONTAR INVENTARIO (Dinámico por País)
--            Descuenta el stock del lote 101 de la tienda principal del país del cliente.
CREATE OR REPLACE TRIGGER trg_ai_online_descontar_stock
AFTER INSERT ON DET_FACTURAS_ONLINE
FOR EACH ROW
DECLARE
    v_id_cliente     NUMBER;
    v_id_pais        NUMBER;
    v_target_tienda  NUMBER;
BEGIN
    -- Obtener País de Residencia del Cliente
    SELECT f.id_lego_cliente, c.id_pais_res
    INTO v_id_cliente, v_id_pais
    FROM FACTURAS_ONLINE f
    JOIN CLIENTES c ON f.id_lego_cliente = c.id_lego
    WHERE f.numero_venta = :NEW.numero_venta;

    -- Mapear País a Tienda Principal (Lógica Dinámica)
    v_target_tienda := CASE v_id_pais
                        WHEN 1 THEN 1  -- Hong Kong
                        WHEN 2 THEN 4  -- México
                        WHEN 3 THEN 6  -- Estados Unidos
                        WHEN 4 THEN 8  -- Polonia
                        ELSE 6         -- Default a USA
                       END;
      
    -- Descontar del lote principal (101) de la tienda objetivo
    UPDATE LOTES_INVENTARIO
    SET cantidad = cantidad - :NEW.cantidad
    WHERE id_tienda  = v_target_tienda
      AND id_juguete = :NEW.id_juguete_cat
      AND id_lote    = 101;
      
    -- Validación
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20025, 'Error de stock: No se pudo descontar el stock del Lote 101 en la Tienda ' || v_target_tienda);
    END IF;
END;
/

-- TRIGGER 3: PROTECCIÓN DE DATOS (Facturas Inmutables)
CREATE OR REPLACE TRIGGER trg_bud_fact_online_proteger
BEFORE UPDATE OR DELETE ON FACTURAS_ONLINE
FOR EACH ROW
BEGIN
    IF DELETING THEN
        RAISE_APPLICATION_ERROR(-20005, 'ACCION DENEGADA: Prohibido eliminar facturas.');
    ELSIF UPDATING THEN
        RAISE_APPLICATION_ERROR(-20006, 'ACCION DENEGADA: Las facturas son inmutables.');
    END IF;
END;
/


PARTE 4 

CREATE OR REPLACE PROCEDURE sp_procesar_venta_online (
    p_id_cliente      IN CLIENTES.id_lego%TYPE,
    p_productos_carrito IN t_productos_compra
) IS
    v_puntos_actuales   NUMBER;
    v_es_gratis         CHAR(1);
    v_puntos_venta      NUMBER;
    v_subtotal_calculado NUMBER(10, 2) := 0;
    v_next_numero_venta FACTURAS_ONLINE.numero_venta%TYPE;
    
    v_precio_unitario   HIST_PRECIOS.precio%TYPE;
    v_stock_disponible  JUGUETES_LEGO.nro_piezas%TYPE;
    v_edad_cliente      NUMBER(3);
    v_id_pais_cliente   PAISES.id%TYPE;
    
    -- Excepciones Personalizadas
    e_edad_no_cumplida EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_edad_no_cumplida, -20021);
    e_stock_insuficiente EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_stock_insuficiente, -20020);
    e_cliente_no_encontrado EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_cliente_no_encontrado, -20013);
    
BEGIN
    -- 1. VALIDAR EDAD (+21)
    BEGIN
        SELECT edad(fecha_nacimiento), id_pais_res
        INTO v_edad_cliente, v_id_pais_cliente
        FROM CLIENTES WHERE id_lego = p_id_cliente;
        
        IF v_edad_cliente < 21 THEN
            RAISE_APPLICATION_ERROR(-20021, 'COMPRA DENEGADA: El titular debe ser mayor de 21 años para compras online.');
        END IF;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20013, 'Cliente no encontrado.');
    END;

    -- 2. BLOQUEAR INVENTARIO Y CALCULAR SUBTOTAL
    FOR i IN 1 .. p_productos_carrito.COUNT LOOP
        
        SELECT p.precio, j.nro_piezas
        INTO v_precio_unitario, v_stock_disponible
        FROM JUGUETES_LEGO j
        JOIN HIST_PRECIOS p ON j.id = p.id_juguete
        WHERE j.id = p_productos_carrito(i).id_juguete
          AND p.fecha_fin IS NULL
        FOR UPDATE OF j.nro_piezas NOWAIT;
        
        IF v_stock_disponible < p_productos_carrito(i).cantidad THEN
            RAISE_APPLICATION_ERROR(-20020, 'Stock insuficiente para juguete ID: ' || p_productos_carrito(i).id_juguete);
        END IF;
        
        v_subtotal_calculado := v_subtotal_calculado + (p_productos_carrito(i).cantidad * v_precio_unitario);
    END LOOP;
    
    -- 3. LÓGICA DE CANJE (Event Sourcing)
    v_puntos_actuales := fn_calcular_puntos_disponibles(p_id_cliente);

    IF v_puntos_actuales >= 500 THEN
        v_es_gratis    := 'S';
        v_puntos_venta := 0; 
        v_subtotal_calculado := 0;
    ELSE
        v_es_gratis    := 'N';
        v_puntos_venta := fn_calcular_puntos_ganados(v_subtotal_calculado);
    END IF;

    -- 4. GUARDAR CABECERA (El trigger de envío se dispara aquí)
    SELECT seq_factura_online.NEXTVAL INTO v_next_numero_venta FROM DUAL;
    
    INSERT INTO FACTURAS_ONLINE (
        numero_venta, fecha_venta, total, puntos_generados, id_lego_cliente, gratis 
    ) VALUES (
        v_next_numero_venta, SYSDATE, v_subtotal_calculado, v_puntos_venta, p_id_cliente, v_es_gratis
    );

    -- 5. INSERTAR DETALLES Y DESCONTAR INVENTARIO
    FOR i IN 1 .. p_productos_carrito.COUNT LOOP
        
        SELECT p.precio INTO v_precio_unitario
        FROM HIST_PRECIOS p
        WHERE p.id_juguete = p_productos_carrito(i).id_juguete AND p.fecha_fin IS NULL;
        
        INSERT INTO DET_FACTURAS_ONLINE (
            numero_venta, id, cantidad, tipo_cliente, id_juguete_cat, id_pais_cat, precio_unitario
        ) VALUES (
            v_next_numero_venta, i, p_productos_carrito(i).cantidad, 'A', 
            p_productos_carrito(i).id_juguete, v_id_pais_cliente, 
            v_precio_unitario
        );
        -- El stock se descuenta automáticamente por el Trigger AFTE INSERT en DET_FACTURAS_ONLINE
        
    END LOOP;
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Venta Online (' || v_next_numero_venta || ') registrada con éxito.');

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20015, 'Error Venta Online: ' || SQLERRM);
END sp_procesar_venta_online;
/


